<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TSH Scholars Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet + MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    :root{
      --bg:#f7f4ef;--panel:#fff;--text:#222;--muted:#6b6b6b;
      --accent:#ff5a5f;--accent-light:#ffd6d8;--chip:#fff1f1;
    }
    body{margin:0;background:var(--bg);color:var(--text);font-family:"Inter","Helvetica Neue",Arial,sans-serif}
    header{display:flex;align-items:center;justify-content:center;background:var(--accent);color:#fff;padding:16px;font-size:18px;font-weight:700;letter-spacing:.4px;text-transform:uppercase}
    #app{display:grid;grid-template-columns:340px 1fr;height:calc(100vh - 64px)}
    #sidebar{background:var(--panel);border-right:2px solid var(--accent-light);padding:20px;overflow-y:auto}
    #map{width:100%;height:100%}

    .stat{display:flex;justify-content:space-between;padding:10px 12px;background:var(--chip);border:1px solid var(--accent-light);border-radius:10px;margin:8px 0}
    .chip{display:inline-flex;align-items:center;gap:.4rem;background:var(--chip);border:1px solid var(--accent-light);padding:6px 10px;border-radius:999px;font-size:12px;color:var(--muted)}
    .controls{display:grid;gap:10px;margin:16px 0}
    .range-wrap input{width:100%;accent-color:var(--accent)}
    .btn{background:var(--accent);border:none;color:#fff;font-weight:600;padding:10px 12px;border-radius:10px;cursor:pointer;transition:all .2s}
    .btn:hover{background:#e44f54}
    .legend{font-size:13px;color:var(--muted);margin-top:10px}
    .footer{font-size:12px;color:var(--muted);margin-top:20px;text-align:center}

    .popup h3{margin:.2rem 0 .6rem;font-size:16px;color:var(--accent)}
    .kpis{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:6px}
    .kpi{background:var(--chip);border:1px solid var(--accent-light);border-radius:8px;padding:8px;text-align:center}
    .kpi .label{color:var(--muted);font-size:11px}
    .kpi .value{font-size:18px;font-weight:700;color:var(--text)}
    .cohort-row{display:flex;justify-content:space-between;align-items:center;gap:10px;margin:6px 0;padding:8px;border:1px solid var(--accent-light);border-radius:8px;background:var(--panel)}
    .cohort-row .meta{font-size:12px;color:var(--muted)}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9999}
    .modal.open{display:flex}
    .modal-content{background:var(--panel);border:1px solid var(--accent-light);border-radius:16px;width:min(1100px,94vw);max-height:88vh;overflow:hidden;display:flex;flex-direction:column}
    .modal-header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--accent-light)}
    .modal-header h2{margin:0;font-size:16px}
    .modal-controls{display:flex;gap:8px;padding:10px 12px;border-bottom:1px solid var(--accent-light)}
    .input{background:#fff;border:1px solid #e9e4de;color:var(--text);border-radius:10px;padding:8px 10px;font-size:13px;width:100%}
    .modal-body{padding:12px;overflow:auto}
    .scholars-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
    .scholar-card{display:flex;gap:10px;padding:10px;border:1px solid #eee;border-radius:12px;background:#fff}
    .scholar-card img{width:64px;height:64px;object-fit:cover;border-radius:8px;background:#f1f1f1}
    .scholar-meta{display:flex;flex-direction:column;gap:2px}
    .scholar-name{font-weight:700;font-size:14px}
    .scholar-study{font-size:12px;color:var(--muted)}
    .scholar-uni{font-size:12px;color:#444}
    .scholar-tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .tag{font-size:11px;padding:3px 8px;border-radius:999px;background:var(--chip);border:1px solid var(--accent-light);color:var(--muted)}

    @media(max-width:900px){#app{grid-template-columns:1fr}#sidebar{order:2;height:auto}#map{height:60vh}}
  </style>
</head>

<body>
  <header>TSH Scholars Map</header>

  <div id="app">
    <aside id="sidebar">
      <div class="stat"><div>Total Cities</div><div id="stat-cities">0</div></div>
      <div class="stat"><div>Total Scholars</div><div id="stat-total">0</div></div>

      <div class="controls">
        <div class="range-wrap">
          <div class="chip">Show cohorts starting ‚â§ <span id="year-label">2026</span></div>
          <input id="year-max" type="range" min="2023" max="2026" value="2026" />
        </div>
        <button class="btn" id="reset-view">Reset View</button>
      </div>

      <div class="legend">Program started in <strong>2023</strong>. Click a city ‚Üí then click a cohort to view scholar profiles.</div>
      <div class="footer">The Social Hub ‚Ä¢ 2023‚Äì2024 (34) & 2025‚Äì2026 (111) ‚Üí Total 145 ü§ç</div>
    </aside>

    <div id="map"></div>
  </div>

  <!-- Modal -->
  <div class="modal" id="scholar-modal" aria-hidden="true" role="dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title">Scholars</h2>
        <button class="btn" id="close-modal">Close</button>
      </div>
      <div class="modal-controls">
        <input id="scholar-search" class="input" placeholder="Search name, study, university‚Ä¶" />
      </div>
      <div class="modal-body">
        <div id="scholars-container" class="scholars-grid"></div>
      </div>
    </div>
  </div>

  <script>
    // === Map setup ===
    const map = L.map('map',{zoomControl:true,scrollWheelZoom:true}).setView([51.5,9],5);
    L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png',{
      maxZoom:18,
      attribution:'&copy; OpenStreetMap contributors'
    }).addTo(map);
    const cluster = L.markerClusterGroup({showCoverageOnHover:false});

    // === Data: cohorts + detailed scholars (2025‚Äì2026) ===
    // 2023‚Äì2024: numbers only (no profiles yet)
    const cities = [
      // ITALY
      {
        city:'Rome', country:'Italy', lat:41.9028, lng:12.4964,
        cohorts:[
          {start:2025,end:2026,count:8, scholars:[
            {name:'Dayana Milieva', study:'MA International Affairs', university:'John Cabot University'},
            {name:'Xani Beatriz Villaraos Seres', study:'-', university:'Rome University of Fine Arts (RUFA)'},
            {name:'Anna Bilous', study:'MA Visual and Innovation Design', university:'Rome University of Fine Arts (RUFA)'},
            {name:'Alberto Cabo Valcarce', study:'MA Accessories Design', university:'Accademia Costume e Moda'},
            {name:'Luiza Osam-Gyaabin', study:'MA Fabric Innovation Design', university:'Accademia Costume e Moda'},
            {name:'Yazeed Isied', study:'MA Cinema and Film Production', university:'Roma Tre University'},
            {name:'Basma Almaza', study:'MA International Studies', university:'Roma Tre University'},
            {name:'Maria Vitoria De Andrade Da Silva', study:'MA Jewelry Design', university:'Accademia Italiana (IAAD)'}
          ]}
        ]
      },
      {
        city:'Florence', country:'Italy', lat:43.7696, lng:11.2558,
        cohorts:[
          {start:2023,end:2024,count:1, scholars:[]},
          {start:2025,end:2026,count:10, scholars:[
            {name:'Claudia Terova Carbajal', study:'MSc Luxury Retail & Business Management', university:'Polimoda'},
            {name:'Taylor Te Whiwhi Wallbank', study:'Young Artist Programme', university:'Mascarade Opera'},
            {name:'Vuyisa Xipu', study:'Opera Studio', university:'Mascarade Opera'},
            {name:'Katerina Borelli', study:'PhD Law', university:'European University Institute (EUI)'},
            {name:'Friederike Orschler', study:'MA Transnational Governance', university:'European University Institute (EUI)'},
            {name:'Milla Trinchero', study:'MA Transnational Governance', university:'European University Institute (EUI)'},
            {name:'Mostafa Hatem Mostafa Zaki Tana', study:'PhD Law', university:'European University Institute (EUI)'},
            {name:'Ahmet Hakan Kayhan', study:'MA Transnational Governance', university:'European University Institute (EUI)'},
            {name:'Shuyang Wu', study:'MRes Economics', university:'European University Institute (EUI)'},
            {name:'Vito Giacobelli', study:'Biennio di Graphic Design', university:'Accademia Italiana'}
          ]}
        ]
      },
      {
        city:'Bologna', country:'Italy', lat:44.4949, lng:11.3426,
        cohorts:[
          {start:2025,end:2026,count:1, scholars:[
            {name:'Laura Zorzi', study:'MA Professional Arrangement and Composition', university:'Creative Hub Academy'}
          ]}
        ]
      },

      // NETHERLANDS
      {
        city:'Amsterdam City', country:'Netherlands', lat:52.3702, lng:4.8952,
        cohorts:[
          {start:2025,end:2026,count:6, scholars:[
            {name:'Joe Gimpel', study:'International Business', university:'HvA ‚Äì Amsterdam University of Applied Sciences'},
            {name:'Junbing Liao', study:'MSc Metropolitan Analysis, Design & Engineering', university:'AMS Institute & Wageningen University & Research'},
            {name:'Asal Moradi', study:'MSc Metropolitan Analysis, Design & Engineering', university:'AMS Institute & Wageningen University & Research'},
            {name:'Jose Abraham Villanueva Cuellar', study:'MSc Metropolitan Analysis, Design & Engineering', university:'AMS Institute & Wageningen University & Research'},
            {name:'Ruthler Louis', study:'Software Engineering', university:'CODAM'},
            {name:'Frederico Campanello', study:'Double Bass Master', university:'Conservatorium van Amsterdam (AHK)'}
          ]}
        ]
      },
      {
        city:'Amsterdam West', country:'Netherlands', lat:52.369, lng:4.853,
        cohorts:[
          {start:2023,end:2024,count:2, scholars:[]},
          {start:2025,end:2026,count:10, scholars:[
            {name:'Eiman Elgaali', study:'MA Public Health and Health Equity', university:'KIT Institute'},
            {name:'Phan Minh Thai', study:'MA Public Health and Health Equity', university:'KIT Institute'},
            {name:'Nataliia Sulym', study:'MA Music', university:'Conservatorium van Amsterdam (AHK)'},
            {name:'Kirutharshan Nicholas John Mariyathas', study:'MA Theatre Makers and Curators in the Performing Arts', university:'AHK ‚Äì Amsterdam University of the Arts'},
            {name:'El Mehdi Banacer', study:'MArch Architecture', university:'AHK ‚Äì Amsterdam University of the Arts'},
            {name:'Shuang Yu', study:'MA Film', university:'AHK ‚Äì Amsterdam University of the Arts'},
            {name:'Aditya Jain', study:'MA Applied Museum and Heritage Studies', university:'AHK ‚Äì Amsterdam University of the Arts'},
            {name:'Itan Nikelskii', study:'-', university:'CODAM'},
            {name:'Antonio Cossari', study:'BA Software Engineering', university:'CODAM'},
            {name:'Julian Zienert', study:'Core Programme', university:'CODAM'}
          ]}
        ]
      },
      {
        city:'Rotterdam', country:'Netherlands', lat:51.924, lng:4.478,
        cohorts:[
          {start:2023,end:2024,count:9, scholars:[]},
          {start:2025,end:2026,count:8, scholars:[
            {name:'Georgios Chomatas', study:'MA Applied History', university:'Erasmus University Rotterdam'},
            {name:'Simon Playe', study:'MA', university:'Erasmus University Rotterdam'},
            {name:'Samuele Pollichemi', study:'MSc Strategic Management', university:'Erasmus University Rotterdam'},
            {name:'Giulia di Santo-Portelli', study:'MA Societal Transitions', university:'Erasmus University Rotterdam'},
            {name:'Pavlos Palvou', study:'MSc Finance and Investments', university:'Erasmus University Rotterdam'},
            {name:'Hien Luong Lai', study:'MSc', university:'Erasmus University Rotterdam'},
            {name:'Lauren Zableckis', study:'MSc Genomics in Society', university:'Erasmus University Rotterdam'},
            {name:'Negul Devan Kesadev Rajeswari', study:'MSc Urban Management and Development', university:'IHS ‚Äì Institute for Housing and Urban Development Studies'}
          ]}
        ]
      },
      {
        city:'Delft', country:'Netherlands', lat:51.9995, lng:4.3627,
        cohorts:[
          {start:2025,end:2026,count:3, scholars:[
            {name:'Milagro Vasquez', study:'MSc Programme in Water and Sustainable Development', university:'IHE Delft'},
            {name:'Esraa Omer Mukhtar', study:'MSc Programme in Water and Sustainable Development', university:'IHE Delft'},
            {name:'Musulene Sharpolu', study:'MSc Programme in Water and Sustainable Development', university:'IHE Delft'}
          ]}
        ]
      },
      {
        city:'Eindhoven', country:'Netherlands', lat:51.4416, lng:5.4697,
        cohorts:[
          {start:2025,end:2026,count:2, scholars:[
            {name:'Jiwon Hyun', study:'MA Societal Design', university:'Design Academy Eindhoven'},
            {name:'Jaeyoung Lee', study:'MA Contextual Design', university:'Design Academy Eindhoven'}
          ]}
        ]
      },
      {
        city:'The Hague', country:'Netherlands', lat:52.0705, lng:4.3007,
        cohorts:[
          {start:2023,end:2024,count:2, scholars:[]},
          {start:2025,end:2026,count:6, scholars:[
            {name:'Udey Dahir', study:'MSc Crisis and Security Management', university:'Leiden University ‚Äì The Hague'},
            {name:'Pragya Misra', study:'MA Development Studies', university:'ISS ‚Äì Erasmus University Rotterdam, The Hague'},
            {name:'Gillian Kipkemboi', study:'MA Development Studies', university:'ISS ‚Äì Erasmus University Rotterdam, The Hague'},
            {name:'Miyu Nohashi', study:'MA Music Performance in Early Music', university:'Royal Conservatoire The Hague'},
            {name:'Leslie Perez-Canto Azaf', study:'NMO National Master in Orchestral Conducting', university:'Royal Conservatoire The Hague'},
            {name:'Zakaria Haij', study:'MSc Environmental Engineering', university:'TU Delft'}
          ]}
        ]
      },
      {
        city:'Maastricht', country:'Netherlands', lat:50.8514, lng:5.691,
        cohorts:[
          {start:2023,end:2024,count:4, scholars:[]},
          {start:2025,end:2026,count:5, scholars:[
            {name:'Emma Przygodda', study:'European Studies on Society, Science and Technology', university:'Maastricht University'},
            {name:'Lea Rebekka Wegert', study:'MSc Cultures of Arts, Science and Technology', university:'Maastricht University'},
            {name:'Nikita Chepkeyvch', study:'MSc Economics and Strategy in Emerging Markets', university:'Maastricht University'},
            {name:'Burak Nuri Demirci', study:'MSc Psychology: Work & Organizational Psychology', university:'Maastricht University'},
            {name:'Doljinsuren Tumurbaatar', study:'MSc Public Policy and Human Development', university:'Maastricht University'}
          ]}
        ]
      },

      // FRANCE
      {
        city:'Toulouse', country:'France', lat:43.6047, lng:1.4442,
        cohorts:[
          {start:2023,end:2024,count:3, scholars:[]},
          {start:2025,end:2026,count:1, scholars:[
            {name:'Mamadou Aliou Diallo', study:'MA Economie Appliqu√©e', university:'Toulouse School of Economics'}
          ]}
        ]
      },

      // SPAIN
      {
        city:'Barcelona', country:'Spain', lat:41.3851, lng:2.1734,
        cohorts:[
          {start:2023,end:2024,count:2, scholars:[]},
          {start:2025,end:2026,count:7, scholars:[
            {name:'Aimen Lakroum', study:'Bachelor English and French Studies', university:'Universitat Aut√≤noma de Barcelona (UAB)'},
            {name:'Muhammad Usman', study:'MA Telecommunication Engineering', university:'Universitat Aut√≤noma de Barcelona (UAB)'},
            {name:'Malik Abdalaal', study:'MSc Research and Innovation in Computer-Based Science and Engineering', university:'Universitat Aut√≤noma de Barcelona (UAB)'},
            {name:'Jesuferanmi Bankole', study:'MA Business Administration', university:'ESADE'},
            {name:'Aswini Kumar', study:'MSc International Management', university:'ESADE'},
            {name:'Idris Mohammad', study:'MSc International Management', university:'ESADE'},
            {name:'Chelsea Sabine Sangwa', study:'International Master in Sustainable Business and Innovation', university:'EADA'}
          ]}
        ]
      },
      {
        city:'Madrid', country:'Spain', lat:40.4168, lng:-3.7038,
        cohorts:[
          {start:2023,end:2024,count:4, scholars:[]},
          {start:2025,end:2026,count:6, scholars:[
            {name:'Iasmina Sharapova', study:'MA Management', university:'IE University'},
            {name:'Shayna van Vuren', study:'MSc Sustainability and Business Transformation', university:'IE University'},
            {name:'Juan Pablo Hern√°ndez Mej√≠a', study:'MA Cultural Project Management', university:'La F√°brica'},
            {name:'Juan Glassford', study:'MA Photographic Projects', university:'La F√°brica'},
            {name:'Azti Correa Alamimos', study:'MA Cultural Project Management', university:'La F√°brica'},
            {name:'Paula Thomas', study:'MA Photographic Projects', university:'La F√°brica'}
          ]}
        ]
      },
      {
        city:'San Sebastian', country:'Spain', lat:43.3183, lng:-1.9812,
        cohorts:[
          {start:2025,end:2026,count:2, scholars:[
            {name:'Frank David Guerra Blanco', study:'MA Cinematographic and Audiovisual Creation', university:'Zine-Eskola'},
            {name:'Noemi Susel Vel√°quez Leg√≥n', study:'MA Film and Audiovisual Archives', university:'Zine-Eskola'}
          ]}
        ]
      },

      // GERMANY
      {
        city:'Berlin', country:'Germany', lat:52.52, lng:13.405,
        cohorts:[
          {start:2025,end:2026,count:6, scholars:[
            {name:'Matej Balint', study:'BSc Data Science and Business Analytics', university:'Forward College'},
            {name:'Azra Zukic', study:'MA International Affairs', university:'Hertie School'},
            {name:'Daniel Sidiqie', study:'MA International Affairs', university:'Hertie School'},
            {name:'Beatriz Patrico Pereira da Cruz', study:'MA Public Administration', university:'Hertie School'},
            {name:'Salma Karen Gomez Lopez', study:'MSc Public Policy', university:'Hertie School'},
            {name:'Vikash Kanna Chandra Prasad Megalai', study:'MSc Sustainable Mobility Management', university:'TU Berlin'}
          ]}
        ]
      },

      // UK
      {
        city:'Glasgow', country:'United Kingdom', lat:55.8642, lng:-4.2518,
        cohorts:[
          {start:2023,end:2024,count:2, scholars:[]},
          {start:2025,end:2026,count:8, scholars:[
            {name:'Joanna Shulha', study:'MA Illustration', university:'Glasgow School of Art'},
            {name:'Keely McLavin', study:'MLitt Curation', university:'Glasgow School of Art'},
            {name:'Riccardo Atanasio', study:'MA Musical Theatre (Musical Directing)', university:'Royal Conservatoire of Scotland'},
            {name:'Artem Tereshchenko', study:'MA Piano Performance', university:'Royal Conservatoire of Scotland'},
            {name:'Jonathan Allen', study:'BEng (Hons) Aero-Mechanical Engineering', university:'University of Strathclyde'},
            {name:'Dillon Bricknal', study:'MSc Forensic Science', university:'University of Strathclyde'},
            {name:'Mfon-Abasi Michael Inyang', study:'MA TV Fiction Writing', university:'Glasgow Caledonian University'},
            {name:'Caleb Chezhian', study:'MSc Investigative Ophthalmology and Vision Science', university:'Glasgow Caledonian University'}
          ]}
        ]
      },

      // AUSTRIA
      {
        city:'Vienna', country:'Austria', lat:48.2082, lng:16.3738,
        cohorts:[
          {start:2023,end:2024,count:5, scholars:[]},
          {start:2025,end:2026,count:10, scholars:[
            {name:'Shreya Parajuli', study:'LLM Human Rights Law', university:'Central European University (CEU)'},
            {name:'Alina Zaripova', study:'MA History', university:'Central European University (CEU)'},
            {name:'Danya Aburoumi', study:'MA Human Rights', university:'Central European University (CEU)'},
            {name:'Syuzanna Poghosyan', study:'MA Economics, Data and Policy', university:'Central European University (CEU)'},
            {name:'Anna Andreasyan', study:'MA Sociology and Social Anthropology', university:'Central European University (CEU)'},
            {name:'Asliya Shodghulomova', study:'MSc Environmental Sciences and Policy', university:'Central European University (CEU)'},
            {name:'Ali Usama', study:'MSc Social Data Science', university:'Central European University (CEU)'},
            {name:'Jiayu Li', study:'MA Music', university:'University of Music and Performing Arts Vienna (MDW)'},
            {name:'Mathapelo Matabane', study:'MA Music', university:'University of Music and Performing Arts Vienna (MDW)'},
            {name:'C√©lest Lang', study:'MA of Music ‚Äì Piano', university:'University of Music and Performing Arts Vienna (MDW)'}
          ]}
        ]
      },

      // PORTUGAL
      {
        city:'Porto', country:'Portugal', lat:41.1579, lng:-8.6291,
        cohorts:[
          {start:2025,end:2026,count:9, scholars:[
            {name:'Lucy Nyoni', study:'International MBA', university:'Porto Business School'},
            {name:'Omid Akabrian', study:'MSc Business Administration (MBA)', university:'Porto Business School'},
            {name:'Cl√°udio Manuel Ant√≥nio', study:'MA Auditing and Taxation', university:'Universidade Cat√≥lica Portuguesa ‚Äì Porto'},
            {name:'Sila K√∂se', study:'MA Cinema', university:'Universidade Cat√≥lica Portuguesa ‚Äì Porto'},
            {name:'Carla Nicole Dominquez Lora', study:'MA Creative Industries Management', university:'Universidade Cat√≥lica Portuguesa ‚Äì Porto'},
            {name:'Doris Dadzie', study:'MA Management', university:'Universidade Cat√≥lica Portuguesa ‚Äì Porto'},
            {name:'Chukwunwike Humphrey Enelamah', study:'MA Management', university:'Universidade Cat√≥lica Portuguesa ‚Äì Porto'},
            {name:'Naman Tariq', study:'MA Law ‚Äì International Studies', university:'Universidade Cat√≥lica Portuguesa ‚Äì Porto'},
            {name:'Ana Beatriz Martins Pereira', study:'Integrated MSc in Medicine', university:'Universidade do Porto'}
          ]}
        ]
      }
    ];

    // === State & elements ===
    let yearMax = 2026;
    const els = {
      statCities: document.getElementById('stat-cities'),
      statTotal:  document.getElementById('stat-total'),
      yearMax: document.getElementById('year-max'),
      yearLabel: document.getElementById('year-label'),
      resetView: document.getElementById('reset-view'),
      modal: document.getElementById('scholar-modal'),
      modalTitle: document.getElementById('modal-title'),
      scholarSearch: document.getElementById('scholar-search'),
      scholarsContainer: document.getElementById('scholars-container'),
      closeModal: document.getElementById('close-modal')
    };

    function activeCountFor(city, yMax){
      return city.cohorts
        .filter(c => (c.start||0) <= yMax)
        .reduce((sum,c)=> sum + (c.count||0), 0);
    }

    function popupHTML(city, yMax){
      const count = activeCountFor(city, yMax);
      const visible = city.cohorts
        .filter(c => (c.start||0) <= yMax)
        .sort((a,b)=>a.start-b.start);

      const rows = visible.map(c=>{
        const recorded = (c.scholars||[]).length;
        const label = recorded
          ? `Showing ${recorded} recorded ‚Ä¢ Total: ${c.count}`
          : `No profiles recorded yet ‚Ä¢ Total: ${c.count}`;
        return `
          <div class="cohort-row">
            <div>
              <strong>${c.start}‚Äì${c.end}</strong>
              <div class="meta">${label}</div>
            </div>
            <button class="btn" onclick="window.__openScholars('${city.city.replace(/'/g,'&#39;')}', '${city.country.replace(/'/g,'&#39;')}', ${c.start}, ${c.end})">
              View scholars
            </button>
          </div>`;
      }).join("");

      return `
        <div>
          <h3>${city.city}, ${city.country}</h3>
          <div class="kpis">
            <div class="kpi"><div class="label">Scholars (shown)</div><div class="value">${count}</div></div>
            <div class="kpi"><div class="label">Cohorts</div><div class="value">${visible.length}</div></div>
          </div>
          ${rows}
        </div>
      `;
    }

    function buildMarkers(){
      cluster.clearLayers();
      let shownCities=0,totalScholars=0;

      cities.forEach(city=>{
        const count = activeCountFor(city, yearMax);
        if(count<=0) return;
        shownCities++; totalScholars += count;

        const m = L.circleMarker([city.lat,city.lng],{
          radius: Math.max(6,Math.min(18,6+Math.sqrt(count))),
          weight:2,color:'#ff5a5f',fillColor:'#ff7d81',fillOpacity:.85
        });
        m.bindPopup(popupHTML(city,yearMax));
        m.on('click',()=>map.setView([city.lat,city.lng],10,{animate:true}));
        cluster.addLayer(m);
      });

      map.addLayer(cluster);
      els.statCities.textContent = shownCities;
      els.statTotal.textContent = totalScholars; // 145 at 2026 with current numbers
    }

    els.yearMax.addEventListener('input',e=>{
      yearMax=+e.target.value; els.yearLabel.textContent=yearMax; buildMarkers();
    });
    els.resetView.addEventListener('click',()=>map.setView([51.5,9],5));

    // === Modal logic ===
    function renderScholars(list){
      els.scholarsContainer.innerHTML = list.map(s=>`
        <div class="scholar-card">
          <img src="" alt="" style="display:none" />
          <div class="scholar-meta">
            <div class="scholar-name">${s.name || 'Unnamed'}</div>
            <div class="scholar-study">${s.study || ''}</div>
            <div class="scholar-uni">${s.university || ''}</div>
            <div class="scholar-tags">${s.cohort ? `<span class="tag">${s.cohort}</span>`:''}</div>
          </div>
        </div>
      `).join('');
    }

    function openScholars(cityName, country, start, end){
      const city = cities.find(c=>c.city===cityName && c.country===country);
      if(!city) return;
      const cohort = city.cohorts.find(c=>c.start===start && c.end===end) || {scholars:[], count:0};
      const base = (cohort.scholars||[]).map(s=> ({...s, cohort:`${start}‚Äì${end}`}));

      els.modalTitle.textContent = `${cityName}, ${country} ‚Äî ${start}‚Äì${end} ‚Ä¢ ${base.length}/${cohort.count} recorded`;
      renderScholars(base);
      els.modal.classList.add('open'); els.modal.setAttribute('aria-hidden','false');

      els.scholarSearch.oninput = () => {
        const q = (els.scholarSearch.value||'').toLowerCase();
        const filtered = base.filter(s => (
          `${s.name||''} ${s.study||''} ${s.university||''}`.toLowerCase().includes(q)
        ));
        renderScholars(filtered);
      };
    }

    function closeModal(){
      els.modal.classList.remove('open');
      els.modal.setAttribute('aria-hidden','true');
      els.scholarSearch.value='';
    }

    window.__openScholars = openScholars;
    els.closeModal.addEventListener('click', closeModal);
    document.getElementById('scholar-modal').addEventListener('click', e=>{
      if(e.target.id==='scholar-modal') closeModal();
    });

    // First render
    buildMarkers();
  </script>
</body>
</html>
