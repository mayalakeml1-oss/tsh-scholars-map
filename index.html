<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TSH Scholars Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet + MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    :root{
      --bg:#f7f4ef;--panel:#fff;--text:#222;--muted:#6b6b6b;
      --accent:#ff5a5f;--accent-light:#ffd6d8;--chip:#fff1f1;
    }
    body{margin:0;background:var(--bg);color:var(--text);font-family:"Inter","Helvetica Neue",Arial,sans-serif}
    header{display:flex;align-items:center;justify-content:center;background:var(--accent);color:#fff;padding:16px;font-size:18px;font-weight:700;letter-spacing:.4px;text-transform:uppercase}
    #app{display:grid;grid-template-columns:340px 1fr;height:calc(100vh - 64px)}
    #sidebar{background:var(--panel);border-right:2px solid var(--accent-light);padding:20px;overflow-y:auto}
    #map{width:100%;height:100%}

    .stat{display:flex;justify-content:space-between;padding:10px 12px;background:var(--chip);border:1px solid var(--accent-light);border-radius:10px;margin:8px 0}
    .chip{display:inline-flex;align-items:center;gap:.4rem;background:var(--chip);border:1px solid var(--accent-light);padding:6px 10px;border-radius:999px;font-size:12px;color:var(--muted)}
    .controls{display:grid;gap:10px;margin:16px 0}
    .range-wrap input{width:100%;accent-color:var(--accent)}
    .btn{background:var(--accent);border:none;color:#fff;font-weight:600;padding:10px 12px;border-radius:10px;cursor:pointer;transition:all .2s}
    .btn:hover{background:#e44f54}
    .legend{font-size:13px;color:var(--muted);margin-top:10px}
    .footer{font-size:12px;color:var(--muted);margin-top:20px;text-align:center}

    .popup h3{margin:.2rem 0 .6rem;font-size:16px;color:var(--accent)}
    .kpis{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:6px}
    .kpi{background:var(--chip);border:1px solid var(--accent-light);border-radius:8px;padding:8px;text-align:center}
    .kpi .label{color:var(--muted);font-size:11px}
    .kpi .value{font-size:18px;font-weight:700;color:var(--text)}
    .cohort-row{display:flex;justify-content:space-between;align-items:center;gap:10px;margin:6px 0;padding:8px;border:1px solid var(--accent-light);border-radius:8px;background:var(--panel)}
    .cohort-row .meta{font-size:12px;color:var(--muted)}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9999}
    .modal.open{display:flex}
    .modal-content{background:var(--panel);border:1px solid var(--accent-light);border-radius:16px;width:min(1100px,94vw);max-height:88vh;overflow:hidden;display:flex;flex-direction:column}
    .modal-header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--accent-light)}
    .modal-header h2{margin:0;font-size:16px}
    .modal-controls{display:flex;gap:8px;padding:10px 12px;border-bottom:1px solid var(--accent-light)}
    .input{background:#fff;border:1px solid #e9e4de;color:var(--text);border-radius:10px;padding:8px 10px;font-size:13px;width:100%}
    .modal-body{padding:12px;overflow:auto}
    .scholars-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
    .scholar-card{display:flex;gap:10px;padding:10px;border:1px solid #eee;border-radius:12px;background:#fff}
    .scholar-avatar{width:52px;height:52px;border-radius:999px;background:var(--chip);display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:700;color:var(--accent);}
    .scholar-meta{display:flex;flex-direction:column;gap:2px}
    .scholar-name{font-weight:700;font-size:14px}
    .scholar-uni{font-size:12px;color:var(--muted);font-weight:500}
    .scholar-study{font-size:12px;color:var(--muted)}
    .scholar-tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .tag{font-size:11px;padding:3px 8px;border-radius:999px;background:var(--chip);border:1px solid var(--accent-light);color:var(--muted)}

    @media(max-width:900px){#app{grid-template-columns:1fr}#sidebar{order:2;height:auto}#map{height:60vh}}
  </style>
</head>

<body>
  <header>TSH Scholars Map</header>

  <div id="app">
    <aside id="sidebar">
      <div class="stat"><div>Total Cities</div><div id="stat-cities">0</div></div>
      <div class="stat"><div>Total Scholars</div><div id="stat-total">0</div></div>

      <div class="controls">
        <div class="range-wrap">
          <div class="chip">Show cohorts starting ‚â§ <span id="year-label">2026</span></div>
          <input id="year-max" type="range" min="2023" max="2026" value="2026" />
        </div>
        <button class="btn" id="reset-view">Reset View</button>
      </div>

      <div class="legend">
        Program started in <strong>2023</strong>. Slide to filter cohorts; click a city ‚Üí view scholar profiles.
      </div>
      <div class="footer">The Social Hub ‚Ä¢ interactive scholar overview ü§ç</div>
    </aside>

    <div id="map"></div>
  </div>

  <!-- Modal -->
  <div class="modal" id="scholar-modal" aria-hidden="true" role="dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title">Scholars</h2>
        <button class="btn" id="close-modal">Close</button>
      </div>
      <div class="modal-controls">
        <input id="scholar-search" class="input" placeholder="Search by name, university, or study‚Ä¶" />
      </div>
      <div class="modal-body">
        <div id="scholars-container" class="scholars-grid"></div>
      </div>
    </div>
  </div>

  <script>
    // === Map setup ===
    const map = L.map('map',{zoomControl:true,scrollWheelZoom:true}).setView([51.5,9],5);
    L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png',{
      maxZoom:18,
      attribution:'&copy; OpenStreetMap contributors'
    }).addTo(map);
    const cluster = L.markerClusterGroup({showCoverageOnHover:false});

    // === Data ===
    // 2023‚Äì2024 counts (no names yet) + full 2025‚Äì2026 scholar lists you gave.
    // NOTE: 2025‚Äì2026 totals from your lists = 108, 2023‚Äì2024 totals = 34 ‚Üí current total in map = 142.
    const cities = [
      // ITALY
      {
        city:'Rome', country:'Italy', lat:41.9028, lng:12.4964,
        cohorts:[
          {
            start:2025, end:2026, count:8,
            scholars:[
              {name:'Dayana Milieva', university:'John Cabot University', study:'MA International Affairs'},
              {name:'Xani Beatriz Villaraos Seres', university:'Rome University of Fine Arts (RUFA)', study:'‚Äî'},
              {name:'Anna Bilous', university:'Rome University of Fine Arts (RUFA)', study:'MA Visual and Innovation Design'},
              {name:'Alberto Cabo Valcarce', university:'Accademia Costume & Moda', study:'MA Accessories Design'},
              {name:'Luiza Osam-Gyaabin', university:'Accademia Costume & Moda', study:'MA Fabric Innovation Design'},
              {name:'Yazeed Isied', university:'Roma Tre University', study:'MA Cinema and Film Production'},
              {name:'Basma Almaza', university:'Roma Tre University', study:'MA International Studies'},
              {name:'Maria Vitoria De Andrade Da Silva', university:'Accademia Italiana / IAAD', study:'MA Jewelry Design'}
            ]
          }
        ]
      },
      {
        city:'Florence', country:'Italy', lat:43.7696, lng:11.2558,
        cohorts:[
          { start:2023, end:2024, count:1, scholars:[] },
          {
            start:2025, end:2026, count:10,
            scholars:[
              {name:'Claudia Terova Carbajal', university:'Polimoda', study:'MSc Luxury Retail & Business Management'},
              {name:'Taylor Te Whiwhi Wallbank', university:'Mascarade Opera', study:'Young Artist Programme'},
              {name:'Vuyisa Xipu', university:'Mascarade Opera', study:'Opera Studio'},
              {name:'Katerina Borelli', university:'European University Institute (EUI)', study:'PhD Law'},
              {name:'Friederike Orschler', university:'EUI', study:'MA Transnational Governance'},
              {name:'Milla Trinchero', university:'EUI', study:'MA Transnational Governance'},
              {name:'Mostafa Hatem Mostafa Zaki Tana', university:'EUI', study:'PhD Law'},
              {name:'Ahmet Hakan Kayhan', university:'EUI', study:'MA Transnational Governance'},
              {name:'Shuyang Wu', university:'EUI', study:'MRes Economics'},
              {name:'Vito Giacobelli', university:'Accademia Italiana', study:'Biennio di Graphic Design'}
            ]
          }
        ]
      },
      {
        city:'Bologna', country:'Italy', lat:44.4949, lng:11.3426,
        cohorts:[
          {
            start:2025, end:2026, count:1,
            scholars:[
              {name:'Laura Zorzi', university:'Creative Hub Academy', study:'MA Professional Arrangement and Composition'}
            ]
          }
        ]
      },

      // NETHERLANDS
      {
        city:'Amsterdam City', country:'Netherlands', lat:52.3702, lng:4.8952,
        cohorts:[
          {
            start:2025, end:2026, count:6,
            scholars:[
              {name:'Joe Gimpel', university:'HvA ‚Äì Amsterdam University of Applied Sciences', study:'International Business'},
              {name:'Junbing Liao', university:'AMS Institute / Wageningen University & Research', study:'MSc Metropolitan Analysis Design & Engineering'},
              {name:'Asal Moradi', university:'AMS Institute / Wageningen University & Research', study:'MSc Metropolitan Analysis Design & Engineering'},
              {name:'Jose Abraham Villanueva Cuellar', university:'AMS Institute / Wageningen University & Research', study:'MSc Metropolitan Analysis Design & Engineering'},
              {name:'Ruthler Louis', university:'CODAM', study:'Software Engineering'},
              {name:'Frederico Campanello', university:'AHK ‚Äì Conservatorium van Amsterdam', study:'Double Bass Master'}
            ]
          }
        ]
      },
      {
        city:'Amsterdam West', country:'Netherlands', lat:52.369, lng:4.853,
        cohorts:[
          { start:2023, end:2024, count:2, scholars:[] },
          {
            start:2025, end:2026, count:10,
            scholars:[
              {name:'Eiman Elgaali', university:'KIT Royal Tropical Institute', study:'MA Public Health and Health Equity'},
              {name:'Phan Minh Thai', university:'KIT Royal Tropical Institute', study:'MA Public Health and Health Equity'},
              {name:'Nataliia Sulym', university:'AHK ‚Äì Conservatorium van Amsterdam', study:'MA Music'},
              {name:'Kirutharshan Nicholas John Mariyathas', university:'AHK ‚Äì Amsterdam University of the Arts', study:'MA Theatre Makers and Curators in the Performing Arts'},
              {name:'El Mehdi Banacer', university:'AHK ‚Äì Amsterdam University of the Arts', study:'MArch Architecture'},
              {name:'Shuang Yu', university:'AHK ‚Äì Amsterdam University of the Arts', study:'MA Film'},
              {name:'Aditya Jain', university:'AHK ‚Äì Amsterdam University of the Arts', study:'MA Applied Museum and Heritage Studies'},
              {name:'Itan Nikelskii', university:'CODAM', study:'‚Äî'},
              {name:'Antonio Cossari', university:'CODAM', study:'BA Software Engineering'},
              {name:'Julian Zienert', university:'CODAM', study:'Core curriculum'}
            ]
          }
        ]
      },
      {
        city:'Rotterdam', country:'Netherlands', lat:51.924, lng:4.478,
        cohorts:[
          { start:2023, end:2024, count:9, scholars:[] },
          {
            start:2025, end:2026, count:8,
            scholars:[
              {name:'Georgios Chomatas', university:'Erasmus University Rotterdam', study:'MA Applied History'},
              {name:'Simon Playe', university:'Erasmus University Rotterdam', study:'MA (discipline unspecified)'},
              {name:'Samuele Pollichemi', university:'Erasmus University Rotterdam', study:'MSc Strategic Management'},
              {name:'Giulia di Santo-Portelli', university:'Erasmus University Rotterdam', study:'MA Societal Transitions'},
              {name:'Pavlos Palvou', university:'Erasmus University Rotterdam', study:'MSc Finance and Investments'},
              {name:'Hien Luong Lai', university:'Erasmus University Rotterdam', study:'MSc (discipline unspecified)'},
              {name:'Lauren Zableckis', university:'Erasmus University Rotterdam', study:'MSc Genomics in Society'},
              {name:'Negul Devan Kesadev Rajeswari', university:'IHS ‚Äì Institute for Housing and Urban Development Studies', study:'MSc Urban Management and Development'}
            ]
          }
        ]
      },
      {
        city:'Delft', country:'Netherlands', lat:51.9995, lng:4.3627,
        cohorts:[
          {
            start:2025, end:2026, count:3,
            scholars:[
              {name:'Milagro Vasquez', university:'IHE Delft', study:'MSc Water and Sustainable Development'},
              {name:'Esraa Omer Mukhtar', university:'IHE Delft', study:'MSc Water and Sustainable Development'},
              {name:'Musulene Sharpolu', university:'IHE Delft', study:'MSc Water and Sustainable Development'}
            ]
          }
        ]
      },
      {
        city:'Eindhoven', country:'Netherlands', lat:51.4416, lng:5.4697,
        cohorts:[
          {
            start:2025, end:2026, count:2,
            scholars:[
              {name:'Jiwon Hyun', university:'Design Academy Eindhoven', study:'MA Societal Design'},
              {name:'Jaeyoung Lee', university:'Design Academy Eindhoven', study:'MA Contextual Design'}
            ]
          }
        ]
      },
      {
        city:'The Hague', country:'Netherlands', lat:52.0705, lng:4.3007,
        cohorts:[
          { start:2023, end:2024, count:2, scholars:[] },
          {
            start:2025, end:2026, count:6,
            scholars:[
              {name:'Udey Dahir', university:'Leiden University ‚Äì Campus The Hague', study:'MSc Crisis and Security Management'},
              {name:'Pragya Misra', university:'ISS ‚Äì Erasmus University Rotterdam', study:'MA Development Studies'},
              {name:'Gillian Kipkemboi', university:'ISS ‚Äì Erasmus University Rotterdam', study:'MA Development Studies'},
              {name:'Miyu Nohashi', university:'Royal Conservatoire The Hague', study:'MA Music Performance (Early Music)'},
              {name:'Leslie Perez-Canto Azaf', university:'Royal Conservatoire The Hague', study:'NMO National Master in Orchestral Conducting'},
              {name:'Zakaria Haij', university:'TU Delft', study:'MSc Environmental Engineering'}
            ]
          }
        ]
      },
      {
        city:'Maastricht', country:'Netherlands', lat:50.8514, lng:5.691,
        cohorts:[
          { start:2023, end:2024, count:4, scholars:[] },
          {
            start:2025, end:2026, count:5,
            scholars:[
              {name:'Emma Przygodda', university:'Maastricht University', study:'European Studies on Society, Science and Technology'},
              {name:'Lea Rebekka Wegert', university:'Maastricht University', study:'MSc Cultures of Arts, Science and Technology'},
              {name:'Nikita Chepkeyvch', university:'Maastricht University', study:'MSc Economics and Strategy in Emerging Markets'},
              {name:'Burak Nuri Demirci', university:'Maastricht University', study:'MSc Psychology ‚Äì Work & Organisational Psychology'},
              {name:'Doljinsuren Tumurbaatar', university:'Maastricht University', study:'MSc Public Policy and Human Development'}
            ]
          }
        ]
      },

      // FRANCE
      {
        city:'Toulouse', country:'France', lat:43.6047, lng:1.4442,
        cohorts:[
          { start:2023, end:2024, count:3, scholars:[] },
          {
            start:2025, end:2026, count:1,
            scholars:[
              {name:'Mamadou Aliou Diallo', university:'Toulouse School of Economics', study:'MA √âconomie Appliqu√©e'}
            ]
          }
        ]
      },

      // SPAIN
      {
        city:'Barcelona', country:'Spain', lat:41.3851, lng:2.1734,
        cohorts:[
          { start:2023, end:2024, count:2, scholars:[] },
          {
            start:2025, end:2026, count:7,
            scholars:[
              {name:'Aimen Lakroum', university:'Universitat Aut√≤noma de Barcelona (UAB)', study:'BA English and French Studies'},
              {name:'Muhammad Usman', university:'UAB', study:'MA Telecommunication Engineering'},
              {name:'Malik Abdalaal', university:'UAB', study:'MSc Research and Innovation in Computer-based Science and Engineering'},
              {name:'Jesuferanmi Bankole', university:'ESADE', study:'MA Business Administration'},
              {name:'Aswini Kumar', university:'ESADE', study:'MSc International Management'},
              {name:'Idris Mohammad', university:'ESADE', study:'MSc International Management'},
              {name:'Chelsea Sabine Sangwa', university:'EADA Business School', study:'International Master in Sustainable Business and Innovation'}
            ]
          }
        ]
      },
      {
        city:'Madrid', country:'Spain', lat:40.4168, lng:-3.7038,
        cohorts:[
          { start:2023, end:2024, count:4, scholars:[] },
          {
            start:2025, end:2026, count:6,
            scholars:[
              {name:'Iasmina Sharapova', university:'IE University', study:'MA Management'},
              {name:'Shayna van Vuren', university:'IE University', study:'MSc Sustainability and Business Transformation'},
              {name:'Juan Pablo Hern√°ndez Mej√≠a', university:'La F√°brica', study:'MA Cultural Project Management'},
              {name:'Juan Glassford', university:'La F√°brica', study:'MA Photographic Projects'},
              {name:'Azti Correa Alamimos', university:'La F√°brica', study:'MA Cultural Project Management'},
              {name:'Paula Thomas', university:'La F√°brica', study:'MA Photographic Projects'}
            ]
          }
        ]
      },
      {
        city:'San Sebastian', country:'Spain', lat:43.3183, lng:-1.9812,
        cohorts:[
          {
            start:2025, end:2026, count:2,
            scholars:[
              {name:'Frank David Guerra Blanco', university:'Zine-Eskola', study:'MA Cinematographic and Audiovisual Creation'},
              {name:'Noemi Susel Vel√°quez Leg√≥n', university:'Zine-Eskola', study:'MA Film and Audiovisual Archives'}
            ]
          }
        ]
      },

      // GERMANY
      {
        city:'Berlin', country:'Germany', lat:52.52, lng:13.405,
        cohorts:[
          {
            start:2025, end:2026, count:6,
            scholars:[
              {name:'Matej Balint', university:'Forward College', study:'BSc Data Science and Business Analytics'},
              {name:'Azra Zukic', university:'Hertie School', study:'MA International Affairs'},
              {name:'Daniel Sidiqie', university:'Hertie School', study:'MA International Affairs'},
              {name:'Beatriz Patrico Pereira da Cruz', university:'Hertie School', study:'MA Public Administration'},
              {name:'Salma Karen Gomez Lopez', university:'Hertie School', study:'MSc Public Policy'},
              {name:'Vikash Kanna Chandra Prasad Megalai', university:'TU Berlin', study:'Sustainable Mobility Management'}
            ]
          }
        ]
      },

      // UK
      {
        city:'Glasgow', country:'United Kingdom', lat:55.8642, lng:-4.2518,
        cohorts:[
          { start:2023, end:2024, count:2, scholars:[] },
          {
            start:2025, end:2026, count:8,
            scholars:[
              {name:'Joanna Shulha', university:'Glasgow School of Art', study:'MA Illustration'},
              {name:'Keely McLavin', university:'Glasgow School of Art', study:'MLitt Curation'},
              {name:'Riccardo Atanasio', university:'Royal Conservatoire of Scotland', study:'MA Musical Theatre (Musical Directing)'},
              {name:'Artem Tereshchenko', university:'Royal Conservatoire of Scotland', study:'MA Piano Performance'},
              {name:'Jonathan Allen', university:'University of Strathclyde', study:'BEng (Hons) Aero-Mechanical Engineering'},
              {name:'Dillon Bricknal', university:'University of Strathclyde', study:'MSc Forensic Science'},
              {name:'Mfon-Abasi Michael Inyang', university:'Glasgow Caledonian University', study:'MA TV Fiction Writing'},
              {name:'Caleb Chezhian', university:'Glasgow Caledonian University', study:'MSc Investigative Ophthalmology and Vision Science'}
            ]
          }
        ]
      },

      // AUSTRIA
      {
        city:'Vienna', country:'Austria', lat:48.2082, lng:16.3738,
        cohorts:[
          { start:2023, end:2024, count:5, scholars:[] },
          {
            start:2025, end:2026, count:10,
            scholars:[
              {name:'Shreya Parajuli', university:'Central European University (CEU)', study:'LLM Human Rights Law'},
              {name:'Alina Zaripova', university:'CEU', study:'MA History'},
              {name:'Danya Aburoumi', university:'CEU', study:'MA Human Rights'},
              {name:'Syuzanna Poghosyan', university:'CEU', study:'MA Economics, Data and Policy'},
              {name:'Anna Andreasyan', university:'CEU', study:'MA Sociology and Social Anthropology'},
              {name:'Asliya Shodghulomova', university:'CEU', study:'MSc Environmental Sciences and Policy'},
              {name:'Ali Usama', university:'CEU', study:'MSc Social Data Science'},
              {name:'Jiayu Li', university:'University of Music and Performing Arts Vienna (MDW)', study:'MA of Music ‚Äì Piano'},
              {name:'Mathapelo Matabane', university:'MDW', study:'MA Music'},
              {name:'C√©lest Lang', university:'MDW', study:'MA of Music ‚Äì Piano'}
            ]
          }
        ]
      },

      // PORTUGAL
      {
        city:'Porto', country:'Portugal', lat:41.1579, lng:-8.6291,
        cohorts:[
          {
            start:2025, end:2026, count:9,
            scholars:[
              {name:'Lucy Nyoni', university:'Porto Business School', study:'International MBA'},
              {name:'Omid Akabrian', university:'Porto Business School', study:'MSc Business Administration (MBA)'},
              {name:'Cl√°udio Manuel Ant√≥nio', university:'Universidade Cat√≥lica Portuguesa ‚Äì Porto', study:'MA Auditing and Taxation'},
              {name:'Sila K√∂se', university:'Universidade Cat√≥lica Portuguesa ‚Äì Porto', study:'MA Cinema'},
              {name:'Carla Nicole Dominquez Lora', university:'Universidade Cat√≥lica Portuguesa ‚Äì Porto', study:'MA Creative Industries Management'},
              {name:'Doris Dadzie', university:'Universidade Cat√≥lica Portuguesa ‚Äì Porto', study:'MA Management'},
              {name:'Chukwunwike Humphrey Enelamah', university:'Universidade Cat√≥lica Portuguesa ‚Äì Porto', study:'MA Management'},
              {name:'Naman Tariq', university:'Universidade Cat√≥lica Portuguesa ‚Äì Porto', study:'MA Law ‚Äì International Studies'},
              {name:'Ana Beatriz Martins Pereira', university:'Universidade do Porto', study:'Integrated MSc in Medicine'}
            ]
          }
        ]
      }
    ];

    // === State & elements ===
    let yearMax = 2026;
    const els = {
      statCities: document.getElementById('stat-cities'),
      statTotal:  document.getElementById('stat-total'),
      yearMax: document.getElementById('year-max'),
      yearLabel: document.getElementById('year-label'),
      resetView: document.getElementById('reset-view'),
      modal: document.getElementById('scholar-modal'),
      modalTitle: document.getElementById('modal-title'),
      scholarSearch: document.getElementById('scholar-search'),
      scholarsContainer: document.getElementById('scholars-container'),
      closeModal: document.getElementById('close-modal')
    };

    function activeCountFor(city, yMax){
      return city.cohorts
        .filter(c => (c.start || 0) <= yMax)
        .reduce((sum, c) => sum + (c.count || 0), 0);
    }

    function popupHTML(city, yMax){
      const count = activeCountFor(city, yMax);
      const visible = city.cohorts
        .filter(c => (c.start || 0) <= yMax)
        .sort((a,b)=>a.start-b.start);

      const rows = visible.map(c=>{
        const recorded = (c.scholars||[]).length;
        return `
          <div class="cohort-row">
            <div>
              <strong>${c.start}‚Äì${c.end}</strong>
              <div class="meta">${recorded ? `Showing ${recorded} recorded` : `No profiles recorded yet`} ‚Ä¢ Total: ${c.count}</div>
            </div>
            <button class="btn" onclick="window.__openScholars('${city.city.replace(/'/g,'&#39;')}', '${city.country.replace(/'/g,'&#39;')}', ${c.start}, ${c.end})">
              View scholars
            </button>
          </div>
        `;
      }).join("");

      return `
        <div>
          <h3>${city.city}, ${city.country}</h3>
          <div class="kpis">
            <div class="kpi"><div class="label">Scholars (shown)</div><div class="value">${count}</div></div>
            <div class="kpi"><div class="label">Cohorts</div><div class="value">${visible.length}</div></div>
          </div>
          ${rows}
        </div>
      `;
    }

    function buildMarkers(){
      cluster.clearLayers();
      let shownCities=0, totalScholars=0;

      cities.forEach(city=>{
        const count = activeCountFor(city, yearMax);
        if(count<=0) return;
        shownCities++; totalScholars += count;

        const m = L.circleMarker([city.lat,city.lng],{
          radius: Math.max(6,Math.min(18,6+Math.sqrt(count))),
          weight:2,color:'#ff5a5f',fillColor:'#ff7d81',fillOpacity:.85
        });
        m.bindPopup(popupHTML(city,yearMax));
        m.on('click',()=>map.setView([city.lat,city.lng],10,{animate:true}));
        cluster.addLayer(m);
      });

      map.addLayer(cluster);
      els.statCities.textContent = shownCities;
      els.statTotal.textContent = totalScholars; // computed from data (currently 142 at 2026)
    }

    // Slider + reset
    els.yearMax.addEventListener('input',e=>{
      yearMax=+e.target.value;
      els.yearLabel.textContent=yearMax;
      buildMarkers();
    });
    els.resetView.addEventListener('click',()=>map.setView([51.5,9],5));

    // === Modal logic ===
    function initials(name){
      if(!name) return '?';
      const parts = name.trim().split(/\s+/);
      if(parts.length === 1) return parts[0].charAt(0).toUpperCase();
      return (parts[0][0] + parts[parts.length-1][0]).toUpperCase();
    }

    function renderScholars(list){
      els.scholarsContainer.innerHTML = list.map(s=>`
        <div class="scholar-card">
          <div class="scholar-avatar">${initials(s.name)}</div>
          <div class="scholar-meta">
            <div class="scholar-name">${s.name || 'Unnamed scholar'}</div>
            <div class="scholar-uni">${s.university || ''}</div>
            <div class="scholar-study">${s.study || ''}</div>
            <div class="scholar-tags">
              ${s.cohort ? `<span class="tag">${s.cohort}</span>` : ''}
              ${s.city ? `<span class="tag">${s.city}</span>` : ''}
            </div>
          </div>
        </div>
      `).join('');
    }

    function openScholars(cityName, country, start, end){
      const city = cities.find(c=>c.city===cityName && c.country===country);
      if(!city) return;
      const cohort = city.cohorts.find(c=>c.start===start && c.end===end) || {scholars:[],count:0};
      const base = (cohort.scholars||[]).map(s=>({
        ...s,
        cohort:`${start}‚Äì${end}`,
        city:cityName
      }));

      els.modalTitle.textContent = `${cityName}, ${country} ‚Äî ${start}‚Äì${end} ‚Ä¢ ${base.length}/${cohort.count} recorded`;
      renderScholars(base);
      els.modal.classList.add('open');
      els.modal.setAttribute('aria-hidden','false');

      els.scholarSearch.value = '';
      els.scholarSearch.oninput = () => {
        const q = els.scholarSearch.value.toLowerCase();
        const filtered = base.filter(s =>
          ((s.name||'') + ' ' + (s.university||'') + ' ' + (s.study||''))
            .toLowerCase()
            .includes(q)
        );
        renderScholars(filtered);
      };
    }

    function closeModal(){
      els.modal.classList.remove('open');
      els.modal.setAttribute('aria-hidden','true');
      els.scholarSearch.value='';
    }

    window.__openScholars = openScholars;
    els.closeModal.addEventListener('click', closeModal);
    document.getElementById('scholar-modal').addEventListener('click', e=>{
      if(e.target.id === 'scholar-modal') closeModal();
    });

    // First render
    buildMarkers();
  </script>
</body>
</html>
